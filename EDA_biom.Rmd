---
title: "BIOM"
# author: "Author's Name"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: no
  html_document:
    theme: cerulean
    toc: yes
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Set up the environment
library(knitr)
opts_chunk$set(cache.path='cache/', fig.path='img/', cache=F, tidy=T, fig.keep='high', echo=F, dpi=100, warnings=F, message=F, comment=NA, warning=F, results='as.is', fig.width = 10, fig.height = 6) #out.width=700, 
library(pander)
panderOptions('table.split.table', Inf)
set.seed(1)
library(dplyr)
options(stringsAsFactors = FALSE)
```

```{r}
library(readr)
library(magrittr)
library(biomformat)
library(ggplot2)
library(DataExplorer)
library(reshape2)
```


```{r settings}
# Data folder
dataDir <- "/Users/mdozmorov/Documents/Data/GitHub/HMP2/ptb/"
# Input files
fileNameIn1  <- "data/hmp_cart_41c0aca569.tsv" # Manifest
fileNameIn2  <- "data/hmp_cart_metadata_26015b0c41.tsv" # Metadata
fileNameIn3  <- "data/downloaded_ascp.txt" # Downloaded files
# Output files
fileNameOut1 <- "data/mtx_biom_ID_all.csv" # All IDs from .biom files
fileNameOut2 <- "data/mtx_biom_data_all.csv" # All data with IDs from .biom files

# Misc
max_files <- 500 # How many files to process
full_data <- FALSE # If true, `max_files` is ignored and all files are processed
```

# Exploratory data analysis

Data source: https://www.hmpdacc.org/hmp/, https://portal.hmpdacc.org/ - data portal. [Files to download](https://portal.hmpdacc.org/search/f?filters=%7B%22op%22:%22and%22,%22content%22:%5B%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22cases.study_name%22,%22value%22:%5B%22MOMS-PI%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.file_format%22,%22value%22:%5B%22Biological%20Observation%20Matrix%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.file_matrix_type%22,%22value%22:%5B%2216s_community%22%5D%7D%7D%5D%7D&facetTab=files&pagination=%7B%22files%22:%7B%22from%22:0,%22size%22:20,%22sort%22:%22file_name.raw:asc%22%7D%7D). Download with `scripts/ascp-commands.sh`

## Load data

```{r}
# Manifest
mtx1 <- read_tsv(fileNameIn1)
# Add file names
mtx1 %<>% mutate(file_name = sapply(mtx1$urls, function(x) strsplit(x, split = ",", fixed = TRUE)[[1]][1] %>% basename) %>% unname)
```

```{r}
# Metadata
mtx2 <- read_tsv(fileNameIn2)
```

Number of subjects with vaginal samples

```{r}
dim(mtx2)
mtx2_vaginal <- subset(mtx2, sample_body_site == "vagina")
length(unique(mtx2$subject_id))
nvisits <- aggregate(visit_number ~ subject_id,  data = mtx2_vaginal, length)
table(nvisits$visit_number)
```


```{r}
# Downloaded files
mtx3 <- read_tsv(fileNameIn3, col_names = FALSE)
# Subset manifest to downloaded files only
mtx1 <- mtx1[ mtx1$file_name %in% mtx3$X1, ]
```


## Read .biom data

```{r}
# All biom files
files <- list.files(path = dataDir, pattern = "biom", full.names = TRUE)
# Sanity check: Are they all in the manifest?
all.equal(files %>% basename %>% sort, mtx1$file_name %>% sort)
```

### Finding nonreadable .biom

Some files throw an error when being read, e.g.

```
in read_biom(files[i]) : Both attempts to read input file:
/Users/mdozmorov/Documents/Data/GitHub/HMP2/ptb//EP988019_K30_MV1D.otu_table.biom
either as JSON (BIOM-v1) or HDF5 (BIOM-v2).
Check file path, file name, file itself, then try again.
```

Manually find their indices in the full matrix, download them separately, remove the nonreadable .biom files from the total list of files.

```{r problemFiles, eval=FALSE}
### Investigation of problematic files

# Breaks on certain files, e.g, 145, EP016061_K20_MV1D.otu_table.biom
# Error in read_biom(files[i]) : Both attempts to read input file:
# /Users/mdozmorov/Documents/Data/GitHub/HMP2/ptb//EP217091_K40_MCHD.otu_table.biom
# either as JSON (BIOM-v1) or HDF5 (BIOM-v2).
# Check file path, file name, file itself, then try again.

# Indices of problematic files
index <- c(145, 159, 208, 308, 819, 1111, 1125, 1189, 1211, 1381, 1529, 1752, 2054, 2175, 2208, 2214, 2275, 2494, 2574, 3003, 3010, 3082, 3411, 3448, 3709, 3989, 3995, 4124, 4234, 4626, 4762, 4950, 5378, 5396, 5399, 5455, 5633, 5755, 5761, 5771, 6099, 6111, 6236, 6240, 6436, 6565, 7454, 7464, 7566, 7750, 7943, 8322, 8360, 8425, 8433, 8461, 8637, 8692, 8770, 9057, 9087, 9107, 9124)
# Manifest data to download missed files
mtx1_missed <- mtx1[mtx1$file_name %in% basename(files)[index], ] # %>% dplyr::select(-file_name)
# Save temporary manifest, convert to download script
write_tsv(mtx1_missed, "biom_nonreadable.tsv") 
# Remove nonreadable files from the folder with all downloaded files
# for file in `cat /Users/mdozmorov/Documents/Work/GitHub/HMP2/data/biom_nonreadable.tsv | cut -f6`; do mv $file .. ; done
# Download nonreadable files separately
# ./hmp_client/bin/manifest2ascp.py --manifest=tmp.tsv --user=mdozmorov --password=FNEMHgvf --ascp_path=/Users/mdozmorov/Applications/Aspera\ CLI/bin/ascp --ascp_options="-l 200M" > ascp-commands_biom_nonreadable.sh


# Non-readable files

files_missed <- list.files(path = "/Users/mdozmorov/Documents/Data/GitHub/HMP2/ptb_nonreadable", pattern = "biom", full.names = TRUE, recursive = TRUE)
files_missed
# Test reading before/after JSON conversion
mtx_biom_missed <- read_biom(files_missed[2])

# JSON conversion
# https://github.com/joey711/phyloseq/issues/443
# source activate qiime1
# for file in *.biom; do biom convert -i $file -o test.biom  --table-type="OTU table" --to-json && mv test.biom $file; done
# source deactivate
```

### Checking each .biom file for readability

After we remove non-readable files, we still check if each of the remaining files can be read. `r length(files)` files should be read without errors (warnings OK).

```{r}
# Check all files for readability
for (i in 1:length(files)) {
    print(paste0(i, " ", basename(files[i])))
    # Read the data
    mtx_biom <- read_biom(files[i]) # Don't do anything, just check if read without errors
}
```


### Extract full matrix

```{r}
# Read the first file to append the following files to
mtx_biom <- read_biom(files[1])
mtx_biom_data_all <- biom_data(mtx_biom) %>% as.data.frame()
colnames(mtx_biom_data_all) <- basename(files[1]) # Name column as the filename
mtx_biom_data_all %<>% mutate(ID = rownames(mtx_biom_data_all)) # Add rownames as IDs

# How many files to process
if (full_data) {
  total <- length(files) # Total number of files
} else {
  total <- max_files # Total number of files
}
# Set progress bar
pb <- txtProgressBar(min = 2, max = total, style = 3)

# Starting from the second file
for (i in 2:total) {
  # Skip certain files
  # Add `index` counts from "problemFiles" to skip
  if (!(i %in% c())) {
    setTxtProgressBar(pb, i)
    # print(paste0(i, " ", basename(files[i])))
    # Read the data
    mtx_biom <- read_biom(files[i])
    mtx_biom_data <- biom_data(mtx_biom) %>% as.data.frame()
    colnames(mtx_biom_data) <- basename(files[i]) # Name column as the filename
    mtx_biom_data %<>% mutate(ID = rownames(mtx_biom_data))  # Add rownames as IDs
    # Full join with the main file
    mtx_biom_data_all <- full_join(mtx_biom_data_all, mtx_biom_data, by = c("ID"))
  }
}

# Put ID column in front
mtx_biom_data_all <- mtx_biom_data_all[, c(colnames(mtx_biom_data_all)[grepl("ID", colnames(mtx_biom_data_all))], colnames(mtx_biom_data_all)[!grepl("ID", colnames(mtx_biom_data_all))])]

write_csv(x = data.frame(mtx_biom_data_all), path = fileNameOut2)
```

```{r eval=FALSE}
### Extract IDs only

# Read the first file to append the following files to
mtx_biom <- read_biom(files[1])
mtx_biom_ID_all <- biom_data(mtx_biom) %>% as.data.frame() %>% rownames # IDs are in rownames

# Process all files
total <- length(files) # Total number of files
# Set progress bar
pb <- txtProgressBar(min = 2, max = total, style = 3)

# Starting from the second file
for (i in 2:total) {
  # Skip certain files
  # Add `index` counts from "problemFiles" to skip
  if (!(i %in% c())) {
    setTxtProgressBar(pb, i)
    # print(paste0(i, " ", basename(files[i])))
    # Read the data
    mtx_biom <- read_biom(files[i])
    mtx_biom_data <- biom_data(mtx_biom) %>% as.data.frame() %>% rownames() # IDs are in rownames
    # Append to mtx_biom_ID_all
    mtx_biom_ID_all <- c(mtx_biom_ID_all, mtx_biom_data) %>% unique()
  }
}
# 7720 unique IDs
write_csv(x = data.frame(mtx_biom_ID_all), path = fileNameOut1)
```

## Biom EDA

`r total` files are processed. Data dimensions: `r dim(mtx_biom_data_all)`

```{r}
mtx_biom_data_all[1:5, 1:5]
```

Count distribution

```{r}
# Prepare data for multiple histograms
data <- mtx_biom_data_all %>% dplyr::select(-ID) %>% melt
data <- data[ complete.cases(data), ] # Remove NAs
print("Summary of count data")
summary(data$value)
data$value <- log2(data$value) # log-transform
# Overlaying density curves
ggplot(data, aes(x = value, fill = variable)) + 
  geom_density(alpha = 0.25) + 
  guides(fill = FALSE) +
  ggtitle("Count distribution") +
  xlab("log2 non-NA counts") +
  ylab("Density")
```

Distribution of sample medians

```{r}
mtx_medians <- sapply(mtx_biom_data_all %>% dplyr::select(-ID), function(x) median(x, na.rm = TRUE))
plot_density(mtx_medians)
```


### Sparsity

```{r}
dim_rows <- nrow(mtx_biom_data_all) # Total number of rows
# Percent of rows with NAs, per sample
pct_nas  <- sapply(mtx_biom_data_all %>% dplyr::select(-ID), function(x) sum(is.na(x)) / dim_rows) %>% unname
# Density histogram
data.frame(pct_nas) %>% plot_density(., title = "Sparsity distribution")
# Summary statistics
summary(pct_nas)
```

# Questions

- What are the row IDs?
- Most sample counts are very small, median = 2. Is it expected?
- There are outliers, like a sample with median counts = 124, maximum count = 206705. Shall we remove such samples?
- The data is very sparse (~97% NAs) - is it expected?

## Metadata EDA


```{r}
plot_bar(mtx2$sample_body_site)
table(mtx2$sample_body_site) %>% sort(., decreasing = TRUE)
```

```{r}
plot_density(mtx2$visit_number)
table(mtx2$visit_number)     %>% sort(., decreasing = TRUE)
```

```{r}
print(paste0("How many total samples: ", nrow(mtx2) ))
print(paste0("How many unique sample IDs: ", unique(mtx2$sample_id) %>% length() ))
print(paste0("How many unique subject IDs: ", unique(mtx2$subject_id) %>% length() ))
print(paste0("How many samples at visit 1: ", sum(mtx2$visit_number == 1) ))
```

```{r echo=TRUE}
# Quick EDA
table(mtx2$subject_gender)   %>% sort(., decreasing = TRUE)
table(mtx2$subject_race)     %>% sort(., decreasing = TRUE)
table(mtx2$study_full_name)  %>% sort(., decreasing = TRUE)
table(mtx2$project_name)     %>% sort(., decreasing = TRUE)
```




