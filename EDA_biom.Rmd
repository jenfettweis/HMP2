---
title: "Exploratory data analysis of .biom files"
# author: "Author's Name"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: no
  html_document:
    theme: cerulean
    toc: yes
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Set up the environment
library(knitr)
opts_chunk$set(cache.path='cache/', fig.path='img/', cache=F, tidy=T, fig.keep='high', echo=F, dpi=100, warnings=F, message=F, comment=NA, warning=F, results='as.is', fig.width = 10, fig.height = 6) #out.width=700, 
library(pander)
panderOptions('table.split.table', Inf)
set.seed(1)
library(dplyr)
options(stringsAsFactors = FALSE)
```

```{r}
library(readr)
library(magrittr)
library(biomformat)
library(ggplot2)
library(DataExplorer)
library(reshape2)
library(openxlsx)
library(MDmisc)
```


```{r settings}
# Data folder
dataDir <- "/Users/mdozmorov/Documents/Data/GitHub/HMP2/"
# Input files
fileNameIn1  <- "data/hmp_cart_41c0aca569.tsv" # Manifest
fileNameIn2  <- "data/hmp_cart_metadata_26015b0c41.tsv" # Metadata
fileNameIn3  <- "data/downloaded_ascp.txt" # Downloaded files
# Output files
fileNameOut1 <- "data/mtx_biom_ID_all.csv" # All IDs from .biom files
fileNameOut2 <- "mtx_biom_data_all_ID-Tax_merged.xlsx" # All data from .biom files, merged by ID and Taxonomy
fileNameOut3 <- "mtx_biom_data_all_ID_merged.xlsx"     # All data from .biom files, merged by ID

# Misc
max_files <- 500 # How many files to process
full_data <- TRUE # If true, `max_files` is ignored and all files are processed
```

# Exploratory data analysis

Data source: https://www.hmpdacc.org/hmp/, https://portal.hmpdacc.org/ - data portal. [Files to download](https://portal.hmpdacc.org/search/f?filters=%7B%22op%22:%22and%22,%22content%22:%5B%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22cases.study_name%22,%22value%22:%5B%22MOMS-PI%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.file_format%22,%22value%22:%5B%22Biological%20Observation%20Matrix%22%5D%7D%7D,%7B%22op%22:%22in%22,%22content%22:%7B%22field%22:%22files.file_matrix_type%22,%22value%22:%5B%2216s_community%22%5D%7D%7D%5D%7D&facetTab=files&pagination=%7B%22files%22:%7B%22from%22:0,%22size%22:20,%22sort%22:%22file_name.raw:asc%22%7D%7D). Download with `scripts/ascp-commands.sh`

## Load data

```{r}
# Manifest
mtx1 <- read_tsv(fileNameIn1)
# Add file names
mtx1 %<>% mutate(file_name = sapply(mtx1$urls, function(x) strsplit(x, split = ",", fixed = TRUE)[[1]][1] %>% basename) %>% unname)
```

```{r}
# Metadata
mtx2 <- read_tsv(fileNameIn2)
```

```{r}
# Downloaded files
mtx3 <- read_tsv(fileNameIn3, col_names = FALSE)
# Subset manifest to downloaded files only
mtx1 <- mtx1[ mtx1$file_name %in% mtx3$X1, ]
```

Number of subjects with vaginal samples

```{r}
dim(mtx2)
mtx2_vaginal <- subset(mtx2, sample_body_site == "vagina")
length(unique(mtx2$subject_id))
nvisits <- aggregate(visit_number ~ subject_id,  data = mtx2_vaginal, length)
table(nvisits$visit_number)
```



## Biom EDA

`r total` files are processed. Data dimensions: `r dim(mtx_biom_data_all)`

```{r}
mtx_biom_data_all[1:5, 1:5]
```

Count distribution

```{r}
# Prepare data for multiple histograms
data <- mtx_biom_data_all %>% dplyr::select(-ID) %>% melt
data <- data[ complete.cases(data), ] # Remove NAs
print("Summary of count data")
summary(data$value)
data$value <- log2(data$value) # log-transform
# Overlaying density curves
ggplot(data, aes(x = value, fill = variable)) + 
  geom_density(alpha = 0.25) + 
  guides(fill = FALSE) +
  ggtitle("Count distribution") +
  xlab("log2 non-NA counts") +
  ylab("Density")
```

Distribution of sample medians

```{r}
mtx_medians <- sapply(mtx_biom_data_all %>% dplyr::select(-ID), function(x) median(x, na.rm = TRUE))
plot_density(mtx_medians)
```


### Sparsity

```{r}
dim_rows <- nrow(mtx_biom_data_all) # Total number of rows
# Percent of rows with NAs, per sample
pct_nas  <- sapply(mtx_biom_data_all %>% dplyr::select(-ID), function(x) sum(is.na(x)) / dim_rows) %>% unname
# Density histogram
data.frame(pct_nas) %>% plot_density(., title = "Sparsity distribution")
# Summary statistics
summary(pct_nas)
```

# Questions

- What are the row IDs?
- Most sample counts are very small, median = 2. Is it expected?
- There are outliers, like a sample with median counts = 124, maximum count = 206705. Shall we remove such samples?
- The data is very sparse (~97% NAs) - is it expected?

## Metadata EDA


```{r}
plot_bar(mtx2$sample_body_site)
table(mtx2$sample_body_site) %>% sort(., decreasing = TRUE)
```

```{r}
plot_density(mtx2$visit_number)
table(mtx2$visit_number)     %>% sort(., decreasing = TRUE)
```

```{r}
print(paste0("How many total samples: ", nrow(mtx2) ))
print(paste0("How many unique sample IDs: ", unique(mtx2$sample_id) %>% length() ))
print(paste0("How many unique subject IDs: ", unique(mtx2$subject_id) %>% length() ))
print(paste0("How many samples at visit 1: ", sum(mtx2$visit_number == 1) ))
```

```{r echo=TRUE}
# Quick EDA
table(mtx2$subject_gender)   %>% sort(., decreasing = TRUE)
table(mtx2$subject_race)     %>% sort(., decreasing = TRUE)
table(mtx2$study_full_name)  %>% sort(., decreasing = TRUE)
table(mtx2$project_name)     %>% sort(., decreasing = TRUE)
```




